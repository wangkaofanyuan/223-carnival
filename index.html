<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é™½æ˜ 223 åœ’éŠæœƒå¿«æ˜“é»</title>
  <!-- è¼‰å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* è¼‰å…¥ Inter å­—é«” */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
    }
    
    /* éš±è—æ»¾å‹•æ¢ (ç”¨æ–¼å½ˆå‡ºè¦–çª—) */
    .modal-open {
      overflow: hidden;
    }
    /* ç°¡å–®çš„è¼‰å…¥å‹•ç•« */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #4f46e5;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* å·¦å´é£¾æ¢æ¨™é¡Œ (æ´»å‹•å€å¡Šç”¨) */
    .title-accent {
      @apply border-l-4 border-indigo-600 pl-4;
    }

    /* + / - æŒ‰éˆ•æ¨£å¼ (Modal å…§) */
    .quantity-btn {
      @apply w-12 h-12 flex items-center justify-center rounded-full text-2xl font-semibold transition-all duration-200;
    }
    
    .quantity-display {
      @apply w-16 text-center text-2xl font-medium text-gray-800;
    }

    /* è³¼ç‰©è»Šå¾½ç« æ¨£å¼ */
    .cart-badge {
      @apply absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center;
    }

    /* å•†å“å¡ç‰‡æ¨¡æ¿ */
    #productCardTemplate {
      display: none;
    }

  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- é é¦– -->
  <!-- ã€ä¿®æ”¹ã€‘åŠ å¤§é™°å½± (shadow-md) -->
  <header class="bg-white shadow-md sticky top-0 z-20">
    <!-- ã€ä¿®æ”¹ã€‘å¢åŠ å…§è· (p-4 md:p-5) -->
    <div class="container mx-auto max-w-4xl p-4 md:p-5 flex flex-row justify-center items-center">
      <!-- ã€ä¿®æ”¹ã€‘åŠ å¤§åœ–ç‰‡ (h-12 w-12) ä¸¦æ›´æ–° inline style -->
      <img src="https://class.kh.edu.tw/sites/4609/upload_file/21/ymjh.png" alt="é™½æ˜åœ‹ä¸­æ ¡å¾½" class="h-12 w-12 mr-4" style="height: 48px; width: 48px;">
      <!-- ã€ä¿®æ”¹ã€‘åŠ å¤§æ–‡å­— (text-2xl md:text-3xl) -->
      <h1 class="text-2xl md:text-3xl font-bold text-indigo-700 text-center tracking-wide">223 åœ’éŠæœƒ - æˆ°åŠ›è£œçµ¦ç«™</h1>
    </div>
  </header>

  <!-- ä¸»å…§å®¹ -->
  <main class="container mx-auto max-w-4xl p-4 pb-28">

    <!-- å•†å“åˆ—è¡¨å®¹å™¨ (æ¨™é¡Œå’Œå…§å®¹éƒ½å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ) -->
    <div id="productList" class="space-y-10">
      
      <!-- è¼‰å…¥ä¸­æç¤º -->
      <div id="loadingProducts" class="p-12 text-center text-gray-500">
        <div class="flex justify-center items-center flex-col">
            <div class="spinner mb-4"></div>
            <span>æ­£åœ¨è¼‰å…¥å•†å“...</span>
        </div>
      </div>

    </div>

    <!-- å•†å“å¡ç‰‡æ¨¡æ¿ (éš±è—ï¼ŒJS æœƒè¤‡è£½é€™å€‹çµæ§‹) -->
    <!-- ä¾æ“šæˆªåœ–é‚„åŸæ¨£å¼ï¼šç™½è‰²èƒŒæ™¯ã€åœ“è§’ã€é™°å½±ã€ç·Šæ¹Šä½ˆå±€ -->
    <div id="productCardTemplate" class="product-card group bg-white rounded-2xl shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden border border-gray-100" data-id="" data-name="" data-price="" data-stock="">
      
      <!-- åœ–ç‰‡å€åŸŸï¼šaspect-square (æ­£æ–¹å½¢)ï¼Œç§»é™¤å›ºå®šé«˜åº¦ï¼Œç¢ºä¿æ»¿ç‰ˆ -->
      <div class="relative w-full aspect-square bg-gray-100 overflow-hidden">
        <!-- object-cover (å¡«æ»¿)ï¼Œç§»é™¤ p-2 (å…§è·)ï¼Œè®“åœ–ç‰‡æ»¿ç‰ˆ -->
        <img src="" alt="å•†å“åœ–ç‰‡" class="product-image w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300">
      </div>
      
      <!-- å…§å®¹å€åŸŸ -->
      <div class="p-4">
        <!-- å•†å“åç¨± -->
        <h4 class="product-name text-lg font-bold text-gray-800 mb-1 leading-tight truncate">å•†å“åç¨±</h4>
        
        <!-- åº«å­˜ -->
        <p class="product-stock text-xs font-medium text-blue-600 mb-3">åº«å­˜: 0</p>
        
        <!-- åƒ¹æ ¼èˆ‡æŒ‰éˆ• -->
        <div class="flex justify-between items-center mt-2">
          <span class="product-price text-xl font-bold text-red-600">NT$0</span>
          
          <!-- ç¶ è‰²åœ“å½¢è³¼ç‰©è»ŠæŒ‰éˆ• (é‚„åŸæˆªåœ–é¢¨æ ¼) -->
          <button class="quantity-select-btn w-10 h-10 bg-green-500 hover:bg-green-600 text-white rounded-full shadow flex items-center justify-center transition-colors duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed" data-action="select-quantity" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.088.832l.994 4.183c.101.423.504.734.954.734h10.468c.45 0 .853-.311.954-.734l.994-4.183c.133-.489.578-.832 1.088-.832h1.386m-20.25 0H21m-19.125 0a.75.75 0 0 0-.729.563L1.5 6.75h21L19.64 3.563a.75.75 0 0 0-.729-.563M3.75 20.25a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm12 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm-9-3.75h10.5a2.25 2.25 0 0 0 2.179-1.399l2.809-5.617a.75.75 0 0 0-.108-.859 1.5 1.5 0 0 0-2.22-.192l-2.613 2.09-2.31-4.816a.75.75 0 0 0-.693-.412H6.38a.75.75 0 0 0-.712.513L3.14 15h11.295a.75.75 0 0 1 0 1.5H3.75v-.75Z" />
            </svg>
          </button>
        </div>
      </div>
    </div>
    <!-- æ¨¡æ¿çµæŸ -->


    <!-- ***** çµ‚æ¥µæŒ‘æˆ°æ´»å‹•å€å¡Š (ä¿ç•™) ***** -->
    <section id="game-challenge" class="mt-16 border-t pt-10">
      <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-gray-100">
        
        <!-- 1. æ¨™é¡Œ -->
        <div class="text-center mb-8">
          <h2 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-orange-500 to-red-500 mb-3">
            ğŸ”¥ çµ‚æ¥µæŒ‘æˆ°ï¼ç¥ä¹‹æ‰‹ï¼šåŒ™ä¾†é‹è½‰ ğŸ”¥
          </h2>
          <p class="text-lg md:text-xl font-bold text-indigo-600">
            ç©éŠæˆ²ï¼Œæ›å¤§çï¼æœ€é«˜å¯ç²å¾—åƒ¹å€¼ $130 å•†å“ï¼
          </p>
        </div>

        <!-- 2. å½±ç‰‡ -->
        <div class="relative rounded-2xl overflow-hidden shadow-lg bg-black mb-12 mx-auto max-w-3xl" style="padding-bottom: 56.25%;">
          <iframe 
            src="https://www.youtube.com/embed/JvJrFoupjjQ?start=100&amp;autoplay=0&amp;mute=1&amp;controls=1&amp;loop=1&amp;playlist=JvJrFoupjjQ" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen
            class="absolute top-0 left-0 w-full h-full"
          ></iframe>
        </div>

        <h3 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-indigo-500 pl-3">æ´»å‹•è©³æƒ…</h3>
        
        <!-- 3. æ´»å‹•è©³æƒ… (ä¸‰æ¬„å¼) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
          <!-- è¦å‰‡ -->
          <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-lg transform hover:-translate-y-1 transition-transform duration-300">
            <h4 class="text-xl font-bold mb-4 flex items-center text-indigo-300">
              <span class="text-3xl mr-3">ğŸ®</span> éŠæˆ²è¦å‰‡
            </h4>
            <ul class="space-y-3 text-slate-200 text-sm leading-relaxed list-disc pl-5">
              <li>è®“ä¹’ä¹“çƒå¾è¼ªå­ã€Œèµ·é»æ¹¯åŒ™ã€å‡ºç™¼ã€‚</li>
              <li>éš¨è‘—è¼ªå­æ—‹è½‰ï¼Œç²¾æº–è½å…¥ã€Œçµ‚é»æ¹¯åŒ™ã€ä¸­ã€‚</li>
              <li>æŒ‘æˆ°å¤±æ•—ï¼šçƒå½ˆå‡ºã€æˆ–çƒé›¢é–‹èµ·é»å¾Œåˆå½ˆå›èµ·é»ã€‚</li>
            </ul>
          </div>

          <!-- è²»ç”¨ -->
          <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-lg transform hover:-translate-y-1 transition-transform duration-300">
            <h4 class="text-xl font-bold mb-4 flex items-center text-yellow-300">
              <span class="text-3xl mr-3">ğŸ’°</span> éŠæˆ²è²»ç”¨
            </h4>
            <ul class="space-y-3 text-slate-200 text-sm leading-relaxed">
              <li class="flex justify-between border-b border-slate-600 pb-2">
                <span>å°è©¦èº«æ‰‹ (1æ¬¡)</span>
                <span class="font-bold text-yellow-400">$10</span>
              </li>
              <li class="flex justify-between border-b border-slate-600 pb-2">
                <span>è¼•é¬†æŒ‘æˆ° (3æ¬¡)</span>
                <span class="font-bold text-yellow-400">$20</span>
              </li>
              <li class="flex justify-between">
                <span>é”äººå¥—é¤ (5æ¬¡)</span>
                <span class="font-bold text-yellow-400">$30</span>
              </li>
            </ul>
          </div>

          <!-- å…Œç -->
          <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-lg transform hover:-translate-y-1 transition-transform duration-300">
            <h4 class="text-xl font-bold mb-4 flex items-center text-red-300">
              <span class="text-3xl mr-3">ğŸ</span> å…Œçæ–¹æ³•
            </h4>
            <ul class="space-y-3 text-slate-200 text-sm leading-relaxed list-disc pl-5">
              <li>çå“ä¾ã€Œæœ€é«˜é€£çºŒæˆåŠŸæ¬¡æ•¸ã€è¨ˆç®— (5æ¬¡ç‚ºé™)ã€‚</li>
              <li>æŒ‘æˆ°æˆåŠŸå¾Œï¼Œé—œä¸»ç¢ºèªç­‰ç´šå¾Œï¼Œæœƒç™¼æ”¾å°æ‡‰çš„<strong>ã€Œçå“ã€ã€‚</li>
                          </ul>
          </div>
        </div>

        <h3 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-indigo-500 pl-3">çå“ä¸€è¦½è¡¨</h3>

        <!-- 4. çå“ä¸€è¦½è¡¨ -->
        <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
          <table class="min-w-full bg-white text-sm text-left">
            <thead class="bg-gray-100 text-gray-700 font-bold uppercase">
              <tr>
                <th class="px-6 py-4">ç­‰ç´š</th>
                <th class="px-6 py-4">é€£çºŒæˆåŠŸ</th>
                <th class="px-6 py-4">çå“ (ä»»é¸ä¸€)</th>
                <th class="px-6 py-4">åƒ¹å€¼</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <tr class="hover:bg-blue-50 transition-colors">
                <td class="px-6 py-4 font-bold text-blue-600">LEVEL 1</td>
                <td class="px-6 py-4 font-bold">1 æ¬¡</td>
                <td class="px-6 py-4">é˜¿å¬¤ã„Ÿç¶ è±†å†° / é¤Šæ¨‚å‡ / å¡å“‡ä¼Šæ°´è±šå› / å‰ä¼ŠèŒå‹æ£’</td>
                <td class="px-6 py-4">$20</td>
              </tr>
              <tr class="hover:bg-green-50 transition-colors">
                <td class="px-6 py-4 font-bold text-green-600">LEVEL 2</td>
                <td class="px-6 py-4 font-bold">2 æ¬¡</td>
                <td class="px-6 py-4">æ‰‹å‹¢åŠ æ²¹æ£’</td>
                <td class="px-6 py-4">$30</td>
              </tr>
              <tr class="hover:bg-yellow-50 transition-colors">
                <td class="px-6 py-4 font-bold text-yellow-600">LEVEL 3</td>
                <td class="px-6 py-4 font-bold">3 æ¬¡</td>
                <td class="px-6 py-4">è‚‰ç‡¥ç‚’æ³¡éºµ / é‡‘æ¦œé¡Œåç‹€å…ƒæ£’</td>
                <td class="px-6 py-4">$40</td>
              </tr>
              <tr class="hover:bg-orange-50 transition-colors">
                <td class="px-6 py-4 font-bold text-orange-600">LEVEL 4</td>
                <td class="px-6 py-4 font-bold">4 æ¬¡</td>
                <td class="px-6 py-4">ç‹‚é‡ç‹¼ç‰™æ£’ / æš´æ“Šåƒå™¸éš / é›å‡æƒ…ç·’æ£’</td>
                <td class="px-6 py-4">$90</td>
              </tr>
              <tr class="bg-yellow-50 hover:bg-yellow-100 transition-colors border-l-4 border-red-500">
                <td class="px-6 py-4 font-black text-red-600 text-base">LEVEL 5</td>
                <td class="px-6 py-4 font-black text-red-600 text-base">5 æ¬¡</td>
                <td class="px-6 py-4 font-black text-red-600">åœ“æ»¿éœ¸æ°£éš / æµæ˜Ÿè¿½æ“Šéš / çµ‚æ¥µæ¯€æ»…éš</td>
                <td class="px-6 py-4 font-black text-red-600 text-base">$130</td>
              </tr>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-medium text-gray-500">å®‰æ…°ç</td>
                <td class="px-6 py-4 text-gray-500">è¼•é¬†æŒ‘æˆ° 3æ¬¡å¤±æ•—</td>
                <td class="px-6 py-4 text-gray-500">ã€Œå¯¦ã€ç”¨ç¦®å“ä¹™ä»½</td>
                <td class="px-6 py-4 text-gray-500">-</td>
              </tr>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-medium text-gray-500">å®‰æ…°ç</td>
                <td class="px-6 py-4 text-gray-500">é”äººå¥—é¤ 5æ¬¡å¤±æ•—</td>
                <td class="px-6 py-4 text-gray-500">$20 å…ƒå•†å“ä»»é¸ä¸€</td>
                <td class="px-6 py-4 text-gray-500">$20</td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </section>

  </main>

  <!-- æµ®å‹•çš„çµå¸³æŒ‰éˆ• (è³¼ç‰©è»Š) -->
  <footer class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-200 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.08)] z-10">
    <div class="container mx-auto max-w-4xl flex justify-between items-center">
      <div class="flex flex-col">
        <span class="text-xs text-gray-500 mb-1">é ä¼°ç¸½é‡‘é¡</span>
        <span id="totalPriceDisplay" class="text-2xl font-bold text-indigo-600 font-mono">NT$0</span>
      </div>
      <button id="checkoutButton" class="relative px-8 py-3 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 flex items-center space-x-2 active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.088.832l.994 4.183c.101.423.504.734.954.734h10.468c.45 0 .853-.311.954-.734l.994-4.183c.133-.489.578-.832 1.088-.832h1.386m-20.25 0H21m-19.125 0a.75.75 0 0 0-.729.563L1.5 6.75h21L19.64 3.563a.75.75 0 0 0-.729-.563M3.75 20.25a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm12 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm-9-3.75h10.5a2.25 2.25 0 0 0 2.179-1.399l2.809-5.617a.75.75 0 0 0-.108-.859 1.5 1.5 0 0 0-2.22-.192l-2.613 2.09-2.31-4.816a.75.75 0 0 0-.693-.412H6.38a.75.75 0 0 0-.712.513L3.14 15h11.295a.75.75 0 0 1 0 1.5H3.75v-.75Z" />
        </svg>
        <span>å‰å¾€çµå¸³</span>
        <span id="cartQuantityBadge" class="cart-badge hidden scale-0 transition-transform duration-200">0</span>
      </button>
    </div>
  </footer>

  <!-- é¸æ“‡æ•¸é‡ å½ˆå‡ºè¦–çª— -->
  <div id="quantityModal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-40 flex items-end sm:items-center sm:justify-center transition-opacity duration-300">
    <div id="quantityModalCard" class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-transform duration-300 ease-out translate-y-full">
      
      <!-- Header -->
      <div class="flex items-start p-6 space-x-4 border-b border-gray-100">
        <img id="modalProductImage" src="" alt="å•†å“åœ–ç‰‡" class="w-20 h-20 rounded-xl object-contain bg-gray-50 border border-gray-100">
        <div class="flex-1">
          <h3 id="modalProductName" class="text-lg font-bold text-gray-800 leading-snug mb-1">å•†å“åç¨±</h3>
          <div class="flex items-baseline space-x-2">
            <p id="modalProductPrice" class="text-xl font-bold text-red-600">NT$0</p>
            <p id="modalProductStock" class="text-sm text-gray-500">åº«å­˜: 0</p>
          </div>
        </div>
        <button id="closeQuantityModalButton" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      
      <!-- Body -->
      <div class="p-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-base font-semibold text-gray-700">è³¼è²·æ•¸é‡</span>
          <div class="flex items-center bg-gray-50 rounded-full p-1 border border-gray-200">
            <button class="quantity-btn quantity-minus w-10 h-10 rounded-full bg-white hover:bg-gray-100 text-gray-600 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all" data-action="decrease" type="button">-</button>
            <span id="modalQuantityDisplay" class="w-12 text-center font-bold text-lg text-gray-800">1</span>
            <button class="quantity-btn quantity-plus w-10 h-10 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white shadow-md shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all" data-action="increase" type="button">+</button>
          </div>
        </div>
        <p id="stockWarning" class="text-red-500 text-xs text-center font-medium h-4 opacity-0 transition-opacity">å·²é”åº«å­˜ä¸Šé™ï¼</p>
      </div>
      
      <!-- Footer -->
      <div class="p-6 pt-2 bg-white">
        <button id="confirmQuantityButton" class="w-full py-3.5 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl active:scale-[0.98] transition-all duration-200">
          ç¢ºèªåŠ å…¥è³¼ç‰©è»Š
        </button>
      </div>
    </div>
  </div>

  <!-- çµå¸³ å½ˆå‡ºè¦–çª— -->
  <div id="orderModal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-30 flex items-end sm:items-center sm:justify-center">
    <div id="modalCard" class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-transform duration-300 ease-out translate-y-full h-[85vh] sm:h-auto max-h-[85vh] flex flex-col">
      <!-- Modal Header -->
      <div class="flex justify-between items-center p-5 border-b bg-white flex-shrink-0">
        <h3 class="text-xl font-bold text-gray-800">çµå¸³ç¢ºèª</h3>
        <button id="closeModalButton" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      
      <!-- Modal Body (Scrollable) -->
      <div class="p-6 overflow-y-auto flex-1">
        
        <!-- 1. è¨‚å–®æ˜ç´° -->
        <div class="mb-8">
          <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">è¨‚å–®æ˜ç´°</h4>
          <div id="confirmItemList" class="space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-100">
            <!-- è¨‚å–®é …ç›® -->
          </div>
          <div id="noItemsMessage" class="hidden text-center text-gray-400 py-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>
        </div>
        
        <!-- 2. è¨‚è³¼äººè³‡è¨Š -->
        <section id="userInfo">
          <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">è¨‚è³¼äººè³‡è¨Š</h4>
          
          <form id="orderForm" class="space-y-4">
            
            <!-- Email ç™»å…¥ç‹€æ…‹ -->
            <? if (userEmail && userEmail !== "") { ?>
              <div class="p-4 bg-blue-50 border border-blue-100 rounded-xl flex items-start space-x-3">
                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                  <p class="text-sm font-bold text-blue-800">å·²ç™»å…¥å¸³è™Ÿ</p>
                  <p id="userEmailDisplay" class="text-sm text-blue-600 break-all"><?= userEmail ?></p>
                </div>
              </div>
            <? } else { ?>
              <div class="p-3 bg-yellow-50 border border-yellow-100 rounded-xl text-sm text-yellow-800 flex items-start space-x-2">
                <svg class="w-5 h-5 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <span>æœªç™»å…¥æ¨¡å¼ï¼šè«‹æº–ç¢ºå¡«å¯«ä»¥ä¸‹è³‡æ–™ï¼Œç³»çµ±å°‡é€²è¡Œ<strong>ä¸‰é‡é©—è­‰</strong>ã€‚</span>
              </div>
            <? } ?>
            
            <div class="grid grid-cols-3 gap-3">
              <div class="col-span-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">å¹´ç´š</label>
                <select id="grade" name="grade" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 text-sm" required>
                  <option value="">é¸æ“‡</option>
                  <option value="ä¸€">ä¸€</option>
                  <option value="äºŒ">äºŒ</option>
                  <option value="ä¸‰">ä¸‰</option>
                  <option value="è€å¸«">è€å¸«</option>
                </select>
              </div>
              <div class="col-span-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">ç­ç´š</label>
                <select id="class" name="class" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 text-sm" required disabled>
                  <option value="">-</option>
                </select>
              </div>
              <div class="col-span-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">åº§è™Ÿ</label>
                <input type="number" id="seatNumber" name="seatNumber" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 text-sm" placeholder="01" required>
              </div>
            </div>

            <!-- å§“åèˆ‡æ€§åˆ¥ -->
            <div class="grid grid-cols-3 gap-3">
               <div id="nameField" class="col-span-2">
                 <label class="block text-xs font-medium text-gray-700 mb-1">å§“å</label>
                 <input type="text" id="name" name="name" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 text-sm" placeholder="çœŸå¯¦å§“å" required>
               </div>
               <div id="genderField" class="col-span-1">
                 <label class="block text-xs font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                 <select id="genderSelect" name="genderSelect" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 text-sm" required>
                   <option value="">-</option>
                   <option value="ç”·">ç”·</option>
                   <option value="å¥³">å¥³</option>
                 </select>
               </div>
            </div>

            <div id="studentIdField">
              <label class="block text-xs font-medium text-gray-700 mb-1">å­¸è™Ÿ (7ç¢¼)</label>
              <input type="text" id="studentIdInput" name="studentIdInput" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 text-sm" placeholder="ä¾‹å¦‚ 1410101" required>
            </div>
            
            <div id="teacherNameField" class="hidden">
              <label class="block text-xs font-medium text-gray-700 mb-1">å§“å</label>
              <input type="text" id="nameTeacher" name="nameTeacher" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 text-sm">
            </div>
            
          </form>
        </section>
      </div>
      
      <!-- Modal Footer -->
      <div class="p-5 bg-white border-t flex justify-between items-center flex-shrink-0">
        <div>
          <span class="text-xs text-gray-500 block">æ‡‰ä»˜é‡‘é¡</span>
          <span id="confirmTotalPrice" class="text-2xl font-bold text-red-600 font-mono">NT$0</span>
        </div>
        <button id="submitOrderButton" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl transition-all flex items-center transform active:scale-95">
          <span id="submitText">ç¢ºèªä¸‹å–®</span>
          <div id="submitSpinner" class="spinner hidden ml-2 border-white/30 border-l-white"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- è¨Šæ¯æç¤º -->
  <div id="messageToast" class="hidden fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl text-white text-sm font-medium z-50 transition-all duration-300 flex items-center space-x-2 min-w-[200px] justify-center opacity-0">
    <p id="messageText"></p>
  </div>

  <script>
    /**
     * ===================================================================
     * åœ’éŠæœƒå•†å“è¨‚è³¼ç³»çµ± - v42 (é‚„åŸç¶“å…¸å¡ç‰‡ç‰ˆ)
     * ===================================================================
     */
    
    // --- å…¨åŸŸè®Šæ•¸ ---
    let cart = {}; 
    let allProducts = new Map(); 
    let currentModalProductId = null;
    let currentModalMaxStock = 0;
    let currentFormData = null;

    // --- éœæ…‹è³‡æ–™ ---
    const classData = {
      "ä¸€": 32, "äºŒ": 34, "ä¸‰": 33, "è€å¸«": 1
    };
    
    const allProductsData = <?!= productsData ?>;

    // -------------------
    // å‡½å¼å®šç¾©
    // -------------------

    function buildProductList(products, productList, cardTemplate, loadingIndicator) {
      if (!productList || !cardTemplate || !loadingIndicator) return;
      
      productList.innerHTML = '';
      allProducts.clear();
      loadingIndicator.classList.add("hidden");
      
      if (!products || products.length === 0) {
        loadingIndicator.textContent = "ç›®å‰æ²’æœ‰å¯è¨‚è³¼çš„å•†å“ã€‚";
        loadingIndicator.classList.remove("hidden");
        productList.appendChild(loadingIndicator);
        return;
      }
      
      const categories = products.reduce((acc, product) => {
        const category = product.category || 'æœªåˆ†é¡';
        if (!acc[category]) acc[category] = [];
        acc[category].push(product);
        return acc;
      }, {});

      Object.keys(categories).forEach(categoryName => {
        
        // åˆ†é¡å€å¡Šå®¹å™¨ï¼šç™½è‰²åœ“è§’å¤§å¡ç‰‡
        const categorySection = document.createElement('section');
        categorySection.className = "bg-white p-5 md:p-8 rounded-3xl shadow-md border border-gray-100";

        // åˆ†é¡æ¨™é¡Œ
        const title = document.createElement('h3');
        title.className = "text-xl font-bold mb-6 text-indigo-700 flex items-center";
        title.innerHTML = `<span class="w-2 h-6 bg-indigo-500 rounded-full mr-3"></span>${categoryName}`;
        categorySection.appendChild(title);

        // å•†å“ç¶²æ ¼ (ã€ä¿®æ”¹ã€‘æ‰‹æ©Ÿç‰ˆé è¨­æ”¹ç‚º 2 æ¬„: grid-cols-2)
        const grid = document.createElement('div');
        // grid-cols-2: æ‰‹æ©Ÿé è¨­é›™æ¬„
        // lg:grid-cols-3: æ¡Œé¢ä¸‰æ¬„
        grid.className = "grid grid-cols-2 lg:grid-cols-3 gap-6";

        const categoryProducts = categories[categoryName];
        categoryProducts.forEach(product => {
          
          allProducts.set(product.id, product);
          
          const card = cardTemplate.cloneNode(true);
          card.id = `product-${product.id}`;
          card.style.display = 'block'; // é¡¯ç¤ºå¡ç‰‡
          
          card.dataset.id = product.id;
          card.dataset.name = product.name;
          card.dataset.price = product.price;
          card.dataset.stock = product.stock;
          
          const imgEl = card.querySelector('.product-image');
          imgEl.src = product.imageUrl;
          imgEl.alt = product.name;
          
          card.querySelector('.product-name').textContent = product.name;
          card.querySelector('.product-price').textContent = `NT$${product.price}`;
          
          const stockDisplay = card.querySelector('.product-stock');
          const button = card.querySelector('.quantity-select-btn');
          
          if (product.stock <= 0) {
            stockDisplay.textContent = "å·²å”®å®Œ";
            stockDisplay.className = "product-stock text-xs font-bold text-gray-400 mb-3";
            button.disabled = true;
            button.classList.add('bg-gray-300', 'hover:bg-gray-300', 'cursor-not-allowed');
            button.classList.remove('bg-green-500', 'hover:bg-green-600', 'shadow');
            // åœ–ç‰‡è®Šç°
            imgEl.classList.add('grayscale', 'opacity-50');
          } else if (product.stock <= 10) {
            stockDisplay.textContent = `åº«å­˜: ${product.stock} (å³å°‡å”®å®Œ)`;
            stockDisplay.className = "product-stock text-xs font-bold text-orange-500 mb-3";
            button.disabled = false;
          } else {
            stockDisplay.textContent = `åº«å­˜: ${product.stock}`;
            button.disabled = false;
          }
          
          grid.appendChild(card);
        });

        categorySection.appendChild(grid);
        productList.appendChild(categorySection);
      });
    }
    
    function refreshProducts(productList, cardTemplate, loadingIndicator, showMessageFn) {
      try {
        loadingIndicator.classList.remove("hidden");
        loadingIndicator.innerHTML = '<div class="spinner mb-2 mx-auto"></div><span class="text-sm">æ›´æ–°åº«å­˜ä¸­...</span>';
        // æ³¨æ„ï¼šä¸è¦æ¸…ç©º productListï¼Œè®“ä½¿ç”¨è€…é‚„çœ‹å¾—åˆ°èˆŠè³‡æ–™ï¼Œé«”é©—è¼ƒå¥½
        
        google.script.run
          .withSuccessHandler((jsonResponse) => {
            const newProducts = JSON.parse(jsonResponse);
            buildProductList(newProducts, productList, cardTemplate, loadingIndicator);
          })
          .withFailureHandler((err) => {
            showMessageFn("error", `ç„¡æ³•é‡æ–°è¼‰å…¥: ${err.message}`);
            loadingIndicator.classList.add("hidden");
          })
          .getProducts();
      } catch (e) {
         showMessageFn("error", `æ›´æ–°å¤±æ•—: ${e.message}`);
      }
    }

    function updateTotal(totalPriceDisplay, confirmTotalPrice, cartQuantityBadge) {
      let total = 0;
      let totalItems = 0;

      for (const id in cart) {
        const quantity = cart[id];
        if (quantity > 0 && allProducts.has(id)) { 
          const product = allProducts.get(id);
          total += product.price * quantity;
          totalItems += quantity;
        }
      }
      
      const formattedTotal = `NT$${total}`;
      if (totalPriceDisplay) totalPriceDisplay.textContent = formattedTotal;
      if (confirmTotalPrice) confirmTotalPrice.textContent = formattedTotal;

      if (cartQuantityBadge) {
        if (totalItems > 0) {
          cartQuantityBadge.textContent = totalItems;
          cartQuantityBadge.classList.remove("hidden", "scale-0");
          cartQuantityBadge.classList.add("scale-100");
        } else {
          cartQuantityBadge.classList.add("scale-0");
          setTimeout(() => cartQuantityBadge.classList.add("hidden"), 200);
        }
      }
    }
    
    function showMessage(messageToast, messageText, type, message) {
      if (!messageToast || !messageText) return;
      messageText.textContent = message;
      
      messageToast.classList.remove("bg-green-500", "bg-red-500", "bg-yellow-500", "hidden", "opacity-0");
      
      if (type === "success") messageToast.classList.add("bg-green-500");
      else if (type === "error") messageToast.classList.add("bg-red-500");
      else messageToast.classList.add("bg-yellow-500");
      
      // Show
      messageToast.classList.remove("hidden");
      requestAnimationFrame(() => {
          messageToast.classList.add("opacity-100", "translate-y-2");
      });
      
      setTimeout(() => {
        messageToast.classList.remove("opacity-100", "translate-y-2");
        messageToast.classList.add("opacity-0");
        setTimeout(() => messageToast.classList.add("hidden"), 300);
      }, 4000);
    }

    function validateUserInfo(elements, showMessageFn) {
      const { gradeSelect, classSelect, seatNumberInput, nameTeacherInput, nameInput, genderSelect, studentIdInput, loggedInEmailEl } = elements;

      if (!gradeSelect.value) { showMessageFn("error", "è«‹é¸æ“‡ã€Œå¹´ç´šã€ï¼"); gradeSelect.focus(); return false; }
      if (!classSelect.value) { showMessageFn("error", "è«‹é¸æ“‡ã€Œç­ç´šã€ï¼"); classSelect.focus(); return false; }
      if (!seatNumberInput.value) { showMessageFn("error", "è«‹è¼¸å…¥ã€Œåº§è™Ÿã€(è€å¸«è«‹å¡« 00)ï¼"); seatNumberInput.focus(); return false; }
      
      if (gradeSelect.value === 'è€å¸«') {
        if (!loggedInEmailEl && !nameTeacherInput.value.trim()) {
          showMessageFn("error", "è«‹è¼¸å…¥ã€Œå§“åã€ï¼"); nameTeacherInput.focus(); return false;
        }
      } else {
        if (!loggedInEmailEl) {
           if (!nameInput.value.trim()) { showMessageFn("error", "è«‹è¼¸å…¥ã€Œå§“åã€ï¼"); nameInput.focus(); return false; }
          if (!genderSelect.value) { showMessageFn("error", "è«‹é¸æ“‡ã€Œæ€§åˆ¥ã€ï¼"); genderSelect.focus(); return false; }
          if (studentIdInput && !studentIdInput.value.trim()) { showMessageFn("error", "è«‹è¼¸å…¥ã€Œå­¸è™Ÿã€ï¼"); studentIdInput.focus(); return false; }
        } else {
          if (!nameInput.value.trim()) { showMessageFn("error", "è«‹è¼¸å…¥ã€Œå§“åã€ï¼"); nameInput.focus(); return false; }
        }
      }
      return true;
    }

    function openCheckoutModal(modal, modalCard) {
      if (!modal || !modalCard) return;
      modal.classList.remove("hidden");
      document.body.classList.add("modal-open");
      requestAnimationFrame(() => modalCard.classList.remove("translate-y-full"));
    }

    function closeCheckoutModal(modal, modalCard) {
      if (!modal || !modalCard) return;
      modalCard.classList.add("translate-y-full");
      document.body.classList.remove("modal-open");
      setTimeout(() => modal.classList.add("hidden"), 300);
    }

    function openQuantityModal(quantityModal, quantityModalCard) {
      if (!quantityModal || !quantityModalCard) return;
      quantityModal.classList.remove("hidden");
      document.body.classList.add("modal-open");
      requestAnimationFrame(() => quantityModalCard.classList.remove("translate-y-full"));
    }

    function closeQuantityModal(quantityModal, quantityModalCard) {
      if (!quantityModal || !quantityModalCard) return;
      quantityModalCard.classList.add("translate-y-full");
      document.body.classList.remove("modal-open");
      const stockWarning = document.getElementById("stockWarning");
      if (stockWarning) stockWarning.classList.add("opacity-0");
      setTimeout(() => quantityModal.classList.add("hidden"), 300);
    }

    function handleValidationSuccess(response, setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn) {
      try {
        const res = JSON.parse(response);
        if (res.isValid) {
          document.getElementById("submitText").textContent = "é©—è­‰æˆåŠŸï¼Œæäº¤ä¸­...";
          google.script.run
            .withSuccessHandler((res) => handleSuccess(res, setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn))
            .withFailureHandler((err) => handleError(err, "", setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn))
            .processOrder(currentFormData);
        } else {
          setLoadingFn(false);
          showMessageFn("error", `é©—è­‰å¤±æ•—ï¼š${res.message}`);
        }
      } catch (e) { handleError(e, response, setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn); }
    }

    function handleSuccess(response, setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn) {
      try {
        setLoadingFn(false);
        const res = JSON.parse(response);
        if (res.status === "success") {
          showMessageFn("success", "è¨‚å–®å·²æˆåŠŸæäº¤ï¼");
          closeCheckoutModalFn();
          
          document.getElementById("orderForm").reset();
          cart = {};
          const badge = document.getElementById("cartQuantityBadge");
          const priceDisplay = document.getElementById("totalPriceDisplay");
          const confirmPrice = document.getElementById("confirmTotalPrice");
          updateTotal(priceDisplay, confirmPrice, badge);
          
          refreshProductsFn();
        } else {
          handleError(new Error(res.message), "", setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn);
        }
      } catch (e) { handleError(e, response, setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn); }
    }

    function handleError(error, rawResponse = "", setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn) {
      setLoadingFn(false);
      let errorMsg = error.message || "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";
      showMessageFn("error", errorMsg);
      if (errorMsg.includes("åº«å­˜ä¸è¶³") || errorMsg.includes("å·²ä¸‹æ¶")) {
        refreshProductsFn();
      }
    }
    
    function setLoading(isLoading) {
      const submitText = document.getElementById("submitText");
      const submitSpinner = document.getElementById("submitSpinner");
      const submitOrderButton = document.getElementById("submitOrderButton");
      
      if (isLoading) {
        submitText.textContent = "è™•ç†ä¸­...";
        submitSpinner.classList.remove("hidden");
        submitOrderButton.disabled = true;
        submitOrderButton.classList.add("opacity-75", "cursor-not-allowed");
      } else {
        submitText.textContent = "ç¢ºèªä¸‹å–®";
        submitSpinner.classList.add("hidden");
        submitOrderButton.disabled = false;
        submitOrderButton.classList.remove("opacity-75", "cursor-not-allowed");
      }
    }

    function updateQuantityModalControls(quantity, maxStock, displayEl, minusBtn, plusBtn, warningEl) {
      if (!displayEl) return;
      quantity = parseInt(quantity, 10);
      maxStock = parseInt(maxStock, 10);
      
      displayEl.textContent = quantity;
      minusBtn.disabled = (quantity <= 0);
      
      if (quantity >= maxStock) {
        plusBtn.disabled = true;
        warningEl.classList.remove("opacity-0");
      } else {
        plusBtn.disabled = false;
        warningEl.classList.add("opacity-0");
      }
    }


    // --- Main Execution ---
    document.addEventListener("DOMContentLoaded", function() {
      
      const gradeSelect = document.getElementById("grade");
      const classSelect = document.getElementById("class");
      const seatNumberInput = document.getElementById("seatNumber");
      const nameInput = document.getElementById("name");
      const genderSelect = document.getElementById("genderSelect");
      const studentIdInput = document.getElementById("studentIdInput");
      const nameField = document.getElementById("nameField");
      const genderField = document.getElementById("genderField");
      const studentIdField = document.getElementById("studentIdField");
      const nameTeacherInput = document.getElementById("nameTeacher");
      const teacherNameField = document.getElementById("teacherNameField");
      const loggedInEmailEl = document.getElementById("userEmailDisplay");

      const productListContainer = document.getElementById("productList");
      const productCardTemplate = document.getElementById("productCardTemplate");
      const loadingProductsIndicator = document.getElementById("loadingProducts");
      const totalPriceDisplay = document.getElementById("totalPriceDisplay");
      const cartQuantityBadge = document.getElementById("cartQuantityBadge");
      const checkoutButton = document.getElementById("checkoutButton");
      
      const modal = document.getElementById("orderModal");
      const modalCard = document.getElementById("modalCard"); 
      const closeModalButton = document.getElementById("closeModalButton");
      const submitOrderButton = document.getElementById("submitOrderButton");
      const confirmTotalPrice = document.getElementById("confirmTotalPrice");
      
      const quantityModal = document.getElementById("quantityModal");
      const quantityModalCard = document.getElementById("quantityModalCard");
      const closeQuantityModalButton = document.getElementById("closeQuantityModalButton");
      const confirmQuantityButton = document.getElementById("confirmQuantityButton");
      const modalProductImage = document.getElementById("modalProductImage");
      const modalProductName = document.getElementById("modalProductName");
      const modalProductPrice = document.getElementById("modalProductPrice");
      const modalProductStock = document.getElementById("modalProductStock");
      const modalQuantityDisplay = document.getElementById("modalQuantityDisplay");
      const modalQuantityMinusBtn = quantityModalCard.querySelector('.quantity-minus');
      const modalQuantityPlusBtn = quantityModalCard.querySelector('.quantity-plus');
      const modalStockWarning = document.getElementById("stockWarning");
      
      const messageToast = document.getElementById("messageToast");
      const messageText = document.getElementById("messageText");

      const showMessageFn = (type, message) => showMessage(messageToast, messageText, type, message);
      const closeCheckoutModalFn = () => closeCheckoutModal(modal, modalCard);
      const setLoadingFn = (isLoading) => setLoading(isLoading);
      const refreshProductsFn = () => refreshProducts(productListContainer, productCardTemplate, loadingProductsIndicator, showMessageFn);


      if (gradeSelect) {
        gradeSelect.addEventListener("change", function() {
          const selectedGrade = this.value;
          classSelect.innerHTML = '<option value="">é¸æ“‡ç­ç´š</option>';
          classSelect.disabled = true;
          
          if (selectedGrade === "è€å¸«") {
            if (!loggedInEmailEl) {
                nameField.classList.add("hidden");
                genderField.classList.add("hidden");
                studentIdField.classList.add("hidden");
                teacherNameField.classList.remove("hidden");
            }
            nameInput.required = false; genderSelect.required = false; studentIdInput.required = false; nameTeacherInput.required = true;
          } else {
            if (!loggedInEmailEl) {
                nameField.classList.remove("hidden");
                genderField.classList.remove("hidden");
                studentIdField.classList.remove("hidden");
                teacherNameField.classList.add("hidden");
            }
            nameInput.required = true; genderSelect.required = true; studentIdInput.required = true; nameTeacherInput.required = false;
          }

          if (selectedGrade && classData[selectedGrade]) {
            classSelect.disabled = false;
            if (selectedGrade === "è€å¸«") {
               classSelect.innerHTML = '<option value="æ•™è·å“¡">æ•™è·å“¡</option>';
            } else {
              for (let i = 1; i <= classData[selectedGrade]; i++) {
                const classNum = i.toString().padStart(2, '0');
                const option = document.createElement("option");
                option.value = classNum;
                option.textContent = `${classNum} ç­`;
                classSelect.appendChild(option);
              }
            }
          }
        });
      }
      
      if (productListContainer) {
        productListContainer.addEventListener("click", function(e) {
          const target = e.target;
          const actionButton = target.closest('[data-action="select-quantity"]');
          
          if (actionButton) {
            const card = actionButton.closest('.product-card');
            if (!card) return;
            
            const id = card.dataset.id;
            if (!allProducts.has(id)) { showMessageFn("error", "å•†å“å·²ä¸‹æ¶"); return; }
            const product = allProducts.get(id);
            
            currentModalProductId = id;
            currentModalMaxStock = product.stock;
            
            modalProductImage.src = product.imageUrl;
            modalProductName.textContent = product.name;
            modalProductPrice.textContent = `NT$${product.price}`;
            modalProductStock.textContent = `åº«å­˜: ${product.stock}`;
            
            const currentQty = cart[id] || 0;
            const displayQty = (currentQty > 0) ? currentQty : 1;
            
            updateQuantityModalControls(displayQty, currentModalMaxStock, modalQuantityDisplay, modalQuantityMinusBtn, modalQuantityPlusBtn, modalStockWarning);
            openQuantityModal(quantityModal, quantityModalCard);
          }
        });
      }
      
      if (checkoutButton) {
        checkoutButton.addEventListener("click", function() {
          const items = [];
          let total = 0;
          
          for (const id in cart) {
            const quantity = cart[id];
            if (quantity > 0 && allProducts.has(id)) {
              const product = allProducts.get(id);
              
              if (product.stock < quantity) {
                 showMessageFn("error", `ã€Œ${product.name}ã€åº«å­˜ä¸è¶³ (å‰© ${product.stock})`);
                 cart[id] = product.stock;
                 if (product.stock === 0) delete cart[id];
                 updateTotal(totalPriceDisplay, confirmTotalPrice, cartQuantityBadge);
                 return;
              }
              items.push({ id: id, name: product.name, price: product.price, quantity: quantity });
              total += product.price * quantity;
            }
          }

          if (items.length === 0) { showMessageFn("error", "è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼"); return; }

          const itemListDiv = document.getElementById("confirmItemList");
          const noItemsMsg = document.getElementById("noItemsMessage");
          itemListDiv.innerHTML = "";
          noItemsMsg.classList.add("hidden");
          
          items.forEach(item => {
            itemListDiv.innerHTML += `
              <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-0">
                <div>
                  <p class="font-bold text-gray-800">${item.name}</p>
                  <p class="text-xs text-gray-500">å–®åƒ¹ $${item.price} x ${item.quantity}</p>
                </div>
                <p class="font-bold text-indigo-600">NT$${item.price * item.quantity}</p>
              </div>
            `;
          });
          
          confirmTotalPrice.textContent = `NT$${total}`;
          openCheckoutModal(modal, modalCard);
        });
      }

      if (closeModalButton) closeModalButton.addEventListener("click", () => closeCheckoutModal(modal, modalCard));
      if (closeQuantityModalButton) closeQuantityModalButton.addEventListener("click", () => closeQuantityModal(quantityModal, quantityModalCard));

      if (quantityModalCard) {
        quantityModalCard.addEventListener("click", function(e) {
          const target = e.target;
          const actionButton = target.closest('[data-action]');
          
          if (actionButton) {
            const action = actionButton.dataset.action;
            let quantity = parseInt(modalQuantityDisplay.textContent, 10);

            if (action === 'increase') { if (quantity < currentModalMaxStock) quantity++; } 
            else if (action === 'decrease') { if (quantity > 0) quantity--; }
            
            updateQuantityModalControls(quantity, currentModalMaxStock, modalQuantityDisplay, modalQuantityMinusBtn, modalQuantityPlusBtn, modalStockWarning);
          }
        });
      }

      if (confirmQuantityButton) {
        confirmQuantityButton.addEventListener("click", function() {
          const id = currentModalProductId;
          if (!id) return;
          const newQty = parseInt(modalQuantityDisplay.textContent, 10);
          if (newQty > 0) cart[id] = newQty; else delete cart[id];
          closeQuantityModal(quantityModal, quantityModalCard);
          updateTotal(totalPriceDisplay, confirmTotalPrice, cartQuantityBadge);
        });
      }

      if (submitOrderButton) {
        submitOrderButton.addEventListener("click", function() {
          const validationElements = { gradeSelect, classSelect, seatNumberInput, nameTeacherInput, nameInput, genderSelect, studentIdInput, loggedInEmailEl };
          if (!validateUserInfo(validationElements, showMessageFn)) return;

          setLoadingFn(true);

          const items = [];
          let total = 0;
          for (const id in cart) {
            const quantity = cart[id];
            if (quantity > 0 && allProducts.has(id)) {
              const product = allProducts.get(id);
              if (product.stock < quantity) {
                showMessageFn("error", `ã€Œ${product.name}ã€åº«å­˜ä¸è¶³ï¼Œè«‹é‡æ–°ç¢ºèª`);
                cart[id] = product.stock; if (product.stock === 0) delete cart[id];
                updateTotal(totalPriceDisplay, confirmTotalPrice, cartQuantityBadge);
                closeCheckoutModalFn(); refreshProductsFn(); setLoadingFn(false); return;
              }
              items.push({ id: id, name: product.name, price: product.price, quantity: quantity });
              total += product.price * quantity;
            }
          }
          
          const grade = gradeSelect.value;
          const classNum = classSelect.value;
          const seatNum = seatNumberInput.value;
          const isTeacher = (grade === 'è€å¸«');
          const name = isTeacher ? nameTeacherInput.value : nameInput.value;
          const gender = isTeacher ? '' : genderSelect.value;
          const studentId = isTeacher ? '' : (studentIdInput ? studentIdInput.value : '');
          const identifier = loggedInEmailEl ? loggedInEmailEl.textContent : (isTeacher ? `${name}-æ•™è·å“¡` : studentId);

          currentFormData = {
            identifier: identifier,
            grade: grade,
            class: classNum === 'æ•™è·å“¡' ? 'æ•™è·å“¡' : `${grade} ${classNum} ç­`,
            seatNumber: seatNum,
            name: name,
            items: items,
            totalPrice: total
          };
          
          try {
            if (loggedInEmailEl || isTeacher) {
              document.getElementById("submitText").textContent = "æäº¤è¨‚å–®ä¸­...";
              google.script.run
                .withSuccessHandler((res) => handleSuccess(res, setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn))
                .withFailureHandler((err) => handleError(err, "", setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn))
                .processOrder(currentFormData);
            } else {
              document.getElementById("submitText").textContent = "è³‡æ–™é©—è­‰ä¸­...";
              const validationInfo = { grade, class: classNum, seatNumber: seatNum, name, studentId, gender };
              google.script.run
                .withSuccessHandler((res) => handleValidationSuccess(res, setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn))
                .withFailureHandler((err) => handleError(err, "", setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn))
                .validateStudent(validationInfo);
            }
          } catch (e) { handleError(e, "Error call.", setLoadingFn, showMessageFn, closeCheckoutModalFn, refreshProductsFn); }
        });
      }

      // Init
      buildProductList(allProductsData, productListContainer, productCardTemplate, loadingProductsIndicator);
      updateTotal(totalPriceDisplay, confirmTotalPrice, cartQuantityBadge);
      
      <? if (!userEmail || userEmail === "") { ?>
          if (gradeSelect.value === 'è€å¸«') {
            nameField.classList.add("hidden"); genderField.classList.add("hidden"); studentIdField.classList.add("hidden"); teacherNameField.classList.remove("hidden");
          } else {
            nameField.classList.remove("hidden"); genderField.classList.remove("hidden"); studentIdField.classList.remove("hidden"); teacherNameField.classList.add("hidden");
          }
      <? } ?>

    });
  </script>
</body>
</html>
